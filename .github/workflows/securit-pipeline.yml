name: Security Pipeline
on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: CodeQL SAST Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
      - name: Build project (Maven) - required for Java codeql analysis
        run: |
          mvn -B -DskipTests package
      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v4

  container-scan:
    name: Build Docker image and run Grype
    runs-on: ubuntu-latest
    needs: codeql
    services: {}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build WebGoat Docker image
        run: |
          docker build -t webgoat-ci:latest .

      - name: Run Anchore/Grype container scan
        # Anchore scan-action uses Grype under the hood
        uses: anchore/scan-action@v2
        with:
          image: webgoat-ci:latest
          fail_severity: 'CRITICAL'
          output: 'sarif'
      - name: Upload SARIF (if the scan-action generated sarif)
        if: ${{ steps.anchore.outputs.sarif-path || always() }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.anchore.outputs.sarif-path || 'grype.sarif' }}

  secret-scan:
    name: Secret Scan (TruffleHog)
    runs-on: ubuntu-latest
    needs: [codeql, container-scan]
    steps:
      - name: Checkout repo (full history for TruffleHog)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}

      - name: Run TruffleHog Actions Scan
        # marketplace action: edplato/trufflehog-actions-scan (wrapper around trufflehog)
        uses: edplato/trufflehog-actions-scan@master
        id: trufflehog
        # optional inputs:
        # with:
        #   scanArguments: "--regex --entropy=False --max_depth=200"

      - name: Fail if secrets found (optional)
        if: steps.trufflehog.outputs.secrets_found == 'true'
        run: |
          echo "Secrets were found by TruffleHog. See action logs for details."
          exit 1

  summary:
    name: Post results summary (Slack, PR comment, etc.)
    runs-on: ubuntu-latest
    needs: [codeql, container-scan, secret-scan]
    steps:
      - name: Action completed - echo summary
        run: |
          echo "SAST, Container scan, and Secret scan finished. Check Security tab and action logs."
